#!/usr/bin/env bash
set -euo pipefail

NUM_KEYS=2
KEYSTORE_DIR="$(mktemp -d -t "aap-ethereum-keystore-XXXXXXXX")"

trap cleanup 0
cleanup()
{
    echo "Removing keystore dir $KEYSTORE_DIR"
    rm -r "$KEYSTORE_DIR"
}

echo "Using keystore dir $KEYSTORE_DIR"
mkdir -p "$KEYSTORE_DIR"

# Import private keys generated by hdwallet-derive script into geth
while IFS= read -r LINE || [[ -n "$LINE" ]]; do
    echo "Importing private key $LINE"
    geth --verbosity 0 --dev --keystore "$KEYSTORE_DIR" \
        account import --password <(echo "") <(echo $LINE)
done < <(hdwallet-derive --mnemonic "$TEST_MNEMONIC" --num-keys $NUM_KEYS --property private_key)

ADDRESS_LIST=$(hdwallet-derive --mnemonic "$TEST_MNEMONIC" --num-keys $NUM_KEYS --property address | tr '\n' ',')

# run geth
geth --http --dev \
    --allow-insecure-unlock \
    --password <(echo "") \
    --keystore $KEYSTORE_DIR --unlock $ADDRESS_LIST
